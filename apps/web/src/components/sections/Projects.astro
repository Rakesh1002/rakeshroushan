---
import { socials } from "@/data/socials";

interface Repo {
  name: string;
  description: string | null;
  html_url: string;
  homepage: string | null;
  stargazers_count: number;
  forks_count: number;
  language: string | null;
  topics: string[];
  pushed_at: string;
  private: boolean;
}

let repos: Repo[] = [];
try {
  const headers: Record<string, string> = {
    Accept: "application/vnd.github+json",
  };
  const token = import.meta.env.GITHUB_TOKEN;
  if (token) headers.Authorization = `Bearer ${token}`;

  const res = await fetch(
    `https://api.github.com/users/Rakesh1002/repos?sort=pushed&per_page=12&type=owner`,
    { headers }
  );
  if (res.ok) {
    const data = await res.json();
    repos = data
      .filter((r: Repo) => !r.private && r.description)
      .slice(0, 6);
  }
} catch {
  // Graceful degradation â€” show nothing if API fails
}
---

<section id="projects" class="py-24 px-6">
  <div class="mx-auto max-w-6xl">
    <div class="flex items-center justify-between mb-12">
      <div>
        <h2 class="text-3xl font-bold mb-4">Projects</h2>
        <p class="text-text-muted">Open source work and side projects.</p>
      </div>
      <a
        href={socials.github}
        target="_blank"
        rel="noopener noreferrer"
        class="hidden sm:inline-flex items-center gap-2 text-sm text-text-muted hover:text-text transition-colors"
      >
        View all on GitHub
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M4.5 19.5l15-15m0 0H8.25m11.25 0v11.25"></path>
        </svg>
      </a>
    </div>

    {
      repos.length > 0 ? (
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          {repos.map((repo) => (
            <a
              href={repo.html_url}
              target="_blank"
              rel="noopener noreferrer"
              class="group block p-5 rounded-xl border border-border hover:border-border-hover bg-bg-card/50 transition-all"
            >
              <div class="flex items-start justify-between mb-3">
                <h3 class="font-semibold group-hover:text-accent transition-colors truncate">
                  {repo.name}
                </h3>
                <svg
                  class="w-4 h-4 text-text-muted shrink-0 ml-2"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M4.5 19.5l15-15m0 0H8.25m11.25 0v11.25"
                  />
                </svg>
              </div>
              <p class="text-sm text-text-muted mb-4 line-clamp-2 leading-relaxed">
                {repo.description}
              </p>
              <div class="flex items-center gap-4 text-xs text-text-muted">
                {repo.language && (
                  <span class="flex items-center gap-1">
                    <span class="w-2.5 h-2.5 rounded-full bg-accent" />
                    {repo.language}
                  </span>
                )}
                {repo.stargazers_count > 0 && (
                  <span class="flex items-center gap-1">
                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                    </svg>
                    {repo.stargazers_count}
                  </span>
                )}
                {repo.forks_count > 0 && (
                  <span class="flex items-center gap-1">
                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M6 3a3 3 0 013 3c0 1.31-.83 2.42-2 2.83V11c0 .55.45 1 1 1h8c.55 0 1-.45 1-1V8.83c-1.17-.41-2-1.52-2-2.83a3 3 0 116 0c0 1.31-.83 2.42-2 2.83V11c0 1.65-1.35 3-3 3h-3v2.17c1.17.41 2 1.52 2 2.83a3 3 0 11-6 0c0-1.31.83-2.42 2-2.83V14H8c-1.65 0-3-1.35-3-3V8.83C3.83 8.42 3 7.31 3 6a3 3 0 013-3z" />
                    </svg>
                    {repo.forks_count}
                  </span>
                )}
              </div>
            </a>
          ))}
        </div>
      ) : (
        <p class="text-text-muted">
          Loading projects...{" "}
          <a
            href={socials.github}
            class="text-accent hover:underline"
          >
            View on GitHub
          </a>
        </p>
      )
    }
  </div>
</section>
